<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ è®¡åˆ’APIæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .result {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å­¦ä¹ è®¡åˆ’APIæµ‹è¯•</h1>
        <p>æµ‹è¯•ä¿®å¤åçš„å­¦ä¹ è®¡åˆ’ç”ŸæˆAPIï¼ŒéªŒè¯è¶…æ—¶é—®é¢˜æ˜¯å¦è§£å†³</p>

        <div class="stats" id="stats">
            <div class="stat">
                <div id="totalTests">æ€»æµ‹è¯•: 0</div>
            </div>
            <div class="stat">
                <div id="successTests">æˆåŠŸ: 0</div>
            </div>
            <div class="stat">
                <div id="failedTests">å¤±è´¥: 0</div>
            </div>
            <div class="stat">
                <div id="avgTime">å¹³å‡æ—¶é—´: 0ms</div>
            </div>
        </div>

        <div class="test-item">
            <h3>ğŸ“ åŸºç¡€åŠŸèƒ½æµ‹è¯•</h3>
            <button onclick="testBasicPlan()">æµ‹è¯•åŸºç¡€å­¦ä¹ è®¡åˆ’</button>
            <button onclick="testMathPlan()">æµ‹è¯•æ•°å­¦è®¡åˆ’</button>
            <button onclick="testComplexPlan()">æµ‹è¯•å¤æ‚è®¡åˆ’</button>
            <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
        </div>

        <div class="test-item">
            <h3>âš¡ æ€§èƒ½æµ‹è¯•</h3>
            <button onclick="testPerformance()">æ€§èƒ½æµ‹è¯•(5æ¬¡)</button>
            <button onclick="testConcurrent()">å¹¶å‘æµ‹è¯•(3ä¸ª)</button>
            <button onclick="testTimeout()">è¶…æ—¶æµ‹è¯•</button>
        </div>

        <div class="test-item">
            <h3>ğŸ”„ é”™è¯¯å¤„ç†æµ‹è¯•</h3>
            <button onclick="testInvalidData()">æ— æ•ˆæ•°æ®æµ‹è¯•</button>
            <button onclick="testEmptyData()">ç©ºæ•°æ®æµ‹è¯•</button>
            <button onclick="testNetworkError()">ç½‘ç»œé”™è¯¯æµ‹è¯•</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let testStats = {
            total: 0,
            success: 0,
            failed: 0,
            times: []
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = `æ€»æµ‹è¯•: ${testStats.total}`
            document.getElementById('successTests').textContent = `æˆåŠŸ: ${testStats.success}`
            document.getElementById('failedTests').textContent = `å¤±è´¥: ${testStats.failed}`
            const avgTime = testStats.times.length > 0 ? 
                Math.round(testStats.times.reduce((a, b) => a + b, 0) / testStats.times.length) : 0
            document.getElementById('avgTime').textContent = `å¹³å‡æ—¶é—´: ${avgTime}ms`
        }

        function addResult(title, success, message, data = null, responseTime = null) {
            const results = document.getElementById('results')
            const div = document.createElement('div')
            div.className = `result ${success ? 'success' : 'error'}`
            
            testStats.total++
            if (success) {
                testStats.success++
                if (responseTime) testStats.times.push(responseTime)
            } else {
                testStats.failed++
            }
            updateStats()
            
            const timestamp = new Date().toLocaleTimeString()
            let content = `[${timestamp}] ${success ? 'âœ…' : 'âŒ'} ${title}\n${message}`
            
            if (responseTime) {
                content += `\nğŸ• å“åº”æ—¶é—´: ${responseTime}ms`
            }
            
            if (data) {
                content += `\nğŸ“Š æ•°æ®: ${JSON.stringify(data, null, 2)}`
            }
            
            div.textContent = content
            results.insertBefore(div, results.firstChild)
        }

        async function callPlanAPI(ocrText, subject = 'math', grade = '1') {
            const startTime = Date.now()
            
            try {
                const response = await fetch('http://192.168.2.120:3000/api/plan/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ocrText: ocrText,
                        subject: subject,
                        grade: grade
                    })
                })

                const responseTime = Date.now() - startTime
                const data = await response.json()

                if (response.ok) {
                    return { success: true, data, responseTime }
                } else {
                    return { success: false, error: data.error || 'æœªçŸ¥é”™è¯¯', responseTime }
                }
            } catch (error) {
                const responseTime = Date.now() - startTime
                return { success: false, error: error.message, responseTime }
            }
        }

        async function testBasicPlan() {
            addResult('åŸºç¡€å­¦ä¹ è®¡åˆ’æµ‹è¯•', true, 'å¼€å§‹æµ‹è¯•...', null, null)
            
            const result = await callPlanAPI(['1 + 1 =', '2 + 2 ='], 'math', '1')
            
            if (result.success) {
                const plan = result.data
                addResult('åŸºç¡€å­¦ä¹ è®¡åˆ’æµ‹è¯•', true, 
                    `æˆåŠŸç”Ÿæˆè®¡åˆ’: ${plan.questionCount}é“é¢˜, æ€»æ—¶é•¿${plan.estimatedTotalTime}åˆ†é’Ÿ`,
                    {
                        planId: plan.planId,
                        questions: plan.questions.length,
                        strategy: plan.learningStrategy,
                        aiGenerated: plan.aiGenerated
                    },
                    result.responseTime
                )
            } else {
                addResult('åŸºç¡€å­¦ä¹ è®¡åˆ’æµ‹è¯•', false, `å¤±è´¥: ${result.error}`, null, result.responseTime)
            }
        }

        async function testMathPlan() {
            addResult('æ•°å­¦è®¡åˆ’æµ‹è¯•', true, 'å¼€å§‹æµ‹è¯•...', null, null)
            
            const mathQuestions = [
                '9 + 1 + 1 =',
                '9 + 2 =',
                '8 + 2 + 3 =',
                '8 + 5 =',
                '7 + 3 + 6 =',
                '7 + 9 ='
            ]
            
            const result = await callPlanAPI(mathQuestions, 'math', '1')
            
            if (result.success) {
                const plan = result.data
                addResult('æ•°å­¦è®¡åˆ’æµ‹è¯•', true, 
                    `æˆåŠŸç”Ÿæˆæ•°å­¦è®¡åˆ’: ${plan.questionCount}é“é¢˜`,
                    {
                        totalTime: plan.estimatedTotalTime,
                        aiGenerated: plan.aiGenerated,
                        sampleQuestion: plan.questions[0]
                    },
                    result.responseTime
                )
            } else {
                addResult('æ•°å­¦è®¡åˆ’æµ‹è¯•', false, `å¤±è´¥: ${result.error}`, null, result.responseTime)
            }
        }

        async function testComplexPlan() {
            addResult('å¤æ‚è®¡åˆ’æµ‹è¯•', true, 'å¼€å§‹æµ‹è¯•...', null, null)
            
            const complexQuestions = Array.from({length: 16}, (_, i) => `é¢˜ç›®${i+1}: å¤æ‚æ•°å­¦åº”ç”¨é¢˜ ${i+1}`)
            
            const result = await callPlanAPI(complexQuestions, 'math', '3')
            
            if (result.success) {
                addResult('å¤æ‚è®¡åˆ’æµ‹è¯•', true, `æˆåŠŸç”Ÿæˆå¤æ‚è®¡åˆ’: ${result.data.questionCount}é“é¢˜`, 
                    { aiGenerated: result.data.aiGenerated }, result.responseTime)
            } else {
                addResult('å¤æ‚è®¡åˆ’æµ‹è¯•', false, `å¤±è´¥: ${result.error}`, null, result.responseTime)
            }
        }

        async function testPerformance() {
            addResult('æ€§èƒ½æµ‹è¯•', true, 'å¼€å§‹5æ¬¡è¿ç»­æµ‹è¯•...', null, null)
            
            const times = []
            for (let i = 0; i < 5; i++) {
                const result = await callPlanAPI([`æµ‹è¯•é¢˜ç›®${i+1}`], 'math', '1')
                times.push(result.responseTime)
                
                if (!result.success) {
                    addResult('æ€§èƒ½æµ‹è¯•', false, `ç¬¬${i+1}æ¬¡å¤±è´¥: ${result.error}`, null, result.responseTime)
                    return
                }
            }
            
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length
            const maxTime = Math.max(...times)
            const minTime = Math.min(...times)
            
            addResult('æ€§èƒ½æµ‹è¯•', true, `å®Œæˆ5æ¬¡æµ‹è¯•`, {
                å¹³å‡æ—¶é—´: `${avgTime.toFixed(0)}ms`,
                æœ€å¿«: `${minTime}ms`,
                æœ€æ…¢: `${maxTime}ms`,
                æ‰€æœ‰æ—¶é—´: times
            })
        }

        async function testConcurrent() {
            addResult('å¹¶å‘æµ‹è¯•', true, 'å¼€å§‹3ä¸ªå¹¶å‘è¯·æ±‚...', null, null)
            
            const promises = [
                callPlanAPI(['å¹¶å‘æµ‹è¯•1'], 'math', '1'),
                callPlanAPI(['å¹¶å‘æµ‹è¯•2'], 'math', '2'),
                callPlanAPI(['å¹¶å‘æµ‹è¯•3'], 'chinese', '1')
            ]
            
            try {
                const results = await Promise.all(promises)
                const successful = results.filter(r => r.success).length
                const times = results.map(r => r.responseTime)
                
                addResult('å¹¶å‘æµ‹è¯•', successful === 3, 
                    `${successful}/3 æˆåŠŸ`,
                    { å“åº”æ—¶é—´: times }
                )
            } catch (error) {
                addResult('å¹¶å‘æµ‹è¯•', false, `å¹¶å‘æµ‹è¯•å¤±è´¥: ${error.message}`)
            }
        }

        async function testTimeout() {
            addResult('è¶…æ—¶æµ‹è¯•', true, 'å¼€å§‹è¶…æ—¶æµ‹è¯•...', null, null)
            
            // æ¨¡æ‹Ÿä¸€ä¸ªå¯èƒ½å¯¼è‡´è¶…æ—¶çš„å¤§è¯·æ±‚
            const largeQuestions = Array.from({length: 50}, (_, i) => 
                `è¿™æ˜¯ä¸€é“éå¸¸å¤æ‚çš„æ•°å­¦åº”ç”¨é¢˜ç›®${i+1}ï¼ŒåŒ…å«å¤šä¸ªæ­¥éª¤å’Œå¤æ‚çš„è®¡ç®—è¿‡ç¨‹ï¼Œéœ€è¦ç»¼åˆè¿ç”¨å„ç§æ•°å­¦çŸ¥è¯†`
            )
            
            const result = await callPlanAPI(largeQuestions, 'math', '6')
            
            if (result.success) {
                addResult('è¶…æ—¶æµ‹è¯•', true, `å¤§æ•°æ®é‡æµ‹è¯•æˆåŠŸ`, 
                    { questions: result.data.questionCount }, result.responseTime)
            } else {
                addResult('è¶…æ—¶æµ‹è¯•', false, `è¶…æ—¶æµ‹è¯•å¤±è´¥: ${result.error}`, null, result.responseTime)
            }
        }

        async function testInvalidData() {
            addResult('æ— æ•ˆæ•°æ®æµ‹è¯•', true, 'æµ‹è¯•æ— æ•ˆæ•°æ®å¤„ç†...', null, null)
            
            const result = await callPlanAPI([], 'math', '1')  // ç©ºæ•°ç»„
            
            if (!result.success) {
                addResult('æ— æ•ˆæ•°æ®æµ‹è¯•', true, `æ­£ç¡®æ‹’ç»æ— æ•ˆæ•°æ®: ${result.error}`, null, result.responseTime)
            } else {
                addResult('æ— æ•ˆæ•°æ®æµ‹è¯•', false, 'åº”è¯¥æ‹’ç»ç©ºæ•°æ®ï¼Œä½†å´æˆåŠŸäº†', result.data, result.responseTime)
            }
        }

        async function testEmptyData() {
            addResult('ç©ºæ•°æ®æµ‹è¯•', true, 'æµ‹è¯•ç©ºæ•°æ®...', null, null)
            
            try {
                const response = await fetch('http://192.168.2.120:3000/api/plan/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                })
                
                const data = await response.json()
                
                if (response.status === 400) {
                    addResult('ç©ºæ•°æ®æµ‹è¯•', true, `æ­£ç¡®è¿”å›400é”™è¯¯: ${data.error}`)
                } else {
                    addResult('ç©ºæ•°æ®æµ‹è¯•', false, `åº”è¯¥è¿”å›400é”™è¯¯ï¼Œå®é™…è¿”å›${response.status}`)
                }
            } catch (error) {
                addResult('ç©ºæ•°æ®æµ‹è¯•', false, `è¯·æ±‚å¤±è´¥: ${error.message}`)
            }
        }

        async function testNetworkError() {
            addResult('ç½‘ç»œé”™è¯¯æµ‹è¯•', true, 'æµ‹è¯•ç½‘ç»œé”™è¯¯å¤„ç†...', null, null)
            
            try {
                const response = await fetch('http://192.168.2.120:3000/api/plan/nonexistent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ocrText: ['test'], subject: 'math', grade: '1' })
                })
                
                if (response.status === 404) {
                    addResult('ç½‘ç»œé”™è¯¯æµ‹è¯•', true, 'æ­£ç¡®è¿”å›404é”™è¯¯')
                } else {
                    addResult('ç½‘ç»œé”™è¯¯æµ‹è¯•', false, `æœŸæœ›404ï¼Œå®é™…${response.status}`)
                }
            } catch (error) {
                addResult('ç½‘ç»œé”™è¯¯æµ‹è¯•', true, `ç½‘ç»œé”™è¯¯æ­£ç¡®å¤„ç†: ${error.message}`)
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = ''
            testStats = { total: 0, success: 0, failed: 0, times: [] }
            updateStats()
            addResult('ç³»ç»Ÿ', true, 'ç»“æœå·²æ¸…ç©º')
        }

        // é¡µé¢åŠ è½½æ—¶è¿›è¡ŒåŸºç¡€æµ‹è¯•
        window.onload = function() {
            addResult('ç³»ç»Ÿ', true, 'å­¦ä¹ è®¡åˆ’APIæµ‹è¯•é¡µé¢å·²åŠ è½½')
        }
    </script>
</body>
</html> 