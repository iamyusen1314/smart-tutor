<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¥ è¶…æ¿€è¿›å‹ç¼© OCR æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #FF6B6B;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        
        .status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #FF6B6B;
        }
        
        .test-button {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }
        
        .upload-section {
            border: 3px dashed #4ECDC4;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #FF6B6B;
            background: rgba(255, 107, 107, 0.05);
        }
        
        #fileInput {
            display: none;
        }
        
        .upload-button {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }
        
        .result {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            min-height: 100px;
        }
        
        .success {
            border-left: 5px solid #27AE60;
            background: linear-gradient(135deg, #D5EDDA 0%, #C8E6C9 100%);
        }
        
        .error {
            border-left: 5px solid #E74C3C;
            background: linear-gradient(135deg, #F8D7DA 0%, #F5C6CB 100%);
        }
        
        .loading {
            border-left: 5px solid #F39C12;
            background: linear-gradient(135deg, #FFF3CD 0%, #FFEAA7 100%);
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .compression-info {
            background: linear-gradient(135deg, #E8F5E8 0%, #F0F8F0 100%);
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .compression-info h3 {
            color: #2E7D32;
            margin-top: 0;
        }
        
        .spec-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .spec-table th, .spec-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .spec-table th {
            background: #FF6B6B;
            color: white;
        }
        
        .highlight {
            background: #FFE082;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ è¶…æ¿€è¿›å‹ç¼© OCR æµ‹è¯•</h1>
        <p class="subtitle">ç›®æ ‡: 30KB + 320px æé™å‹ç¼©ï¼Œå½»åº•è§£å†³ 400 é”™è¯¯</p>
        
        <div class="status">
            <span class="highlight">æœåŠ¡å™¨çŠ¶æ€:</span> <span id="serverStatus">æ£€æŸ¥ä¸­...</span>
        </div>
        
        <div class="compression-info">
            <h3>ğŸ¯ è¶…æ¿€è¿›å‹ç¼©è§„æ ¼</h3>
            <table class="spec-table">
                <tr><th>å‚æ•°</th><th>æ—§ç‰ˆæœ¬</th><th>æ–°ç‰ˆæœ¬</th></tr>
                <tr><td>ç›®æ ‡å¤§å°</td><td>80KB</td><td><span class="highlight">30KB</span></td></tr>
                <tr><td>æœ€å¤§å°ºå¯¸</td><td>600px</td><td><span class="highlight">320px</span></td></tr>
                <tr><td>å›¾ç‰‡æ ¼å¼</td><td>å½©è‰²JPEG</td><td><span class="highlight">ç°åº¦JPEG</span></td></tr>
                <tr><td>èµ·å§‹è´¨é‡</td><td>40%</td><td><span class="highlight">20%</span></td></tr>
                <tr><td>æœ€ä½è´¨é‡</td><td>5%</td><td><span class="highlight">3%</span></td></tr>
                <tr><td>æé™å°ºå¯¸</td><td>300px</td><td><span class="highlight">150px</span></td></tr>
            </table>
        </div>
        
        <div class="test-section">
            <h3>ğŸ§ª é¢„è®¾æµ‹è¯•</h3>
            <button class="test-button" onclick="testSimpleMath()">æµ‹è¯•ç®€å•æ•°å­¦é¢˜</button>
            <button class="test-button" onclick="testComplexMath()">æµ‹è¯•å¤æ‚æ•°å­¦é¢˜</button>
            <button class="test-button" onclick="testLargeImage()">æµ‹è¯•å¤§å›¾ç‰‡å‹ç¼©</button>
            <div id="presetResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“¤ è‡ªå®šä¹‰å›¾ç‰‡æµ‹è¯•</h3>
            <div class="upload-section" onclick="document.getElementById('fileInput').click()">
                <p>ğŸ“ ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</p>
                <button type="button" class="upload-button">é€‰æ‹©å›¾ç‰‡</button>
                <p style="margin-top: 15px; color: #666;">
                    æ”¯æŒ: JPG, PNG, JPEG<br>
                    è‡ªåŠ¨å‹ç¼©è‡³ 30KB ä»¥å†… + 320px
                </p>
            </div>
            <input type="file" id="fileInput" accept="image/*" onchange="testCustomImage(this)">
            <div id="uploadResult" class="result"></div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3000/health')
                const data = await response.json()
                
                if (data.status === 'ok') {
                    document.getElementById('serverStatus').innerHTML = 
                        '<span style="color: #27AE60;">âœ… è¿è¡Œæ­£å¸¸</span> (OCR: ' + data.services.ocr + ')'
                } else {
                    document.getElementById('serverStatus').innerHTML = 
                        '<span style="color: #E74C3C;">âŒ çŠ¶æ€å¼‚å¸¸</span>'
                }
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = 
                    '<span style="color: #E74C3C;">âŒ è¿æ¥å¤±è´¥</span>'
            }
        }
        
        // åˆ›å»ºæµ‹è¯•ç”¨çš„base64å›¾ç‰‡æ•°æ®
        function createTestImage() {
            const canvas = document.createElement('canvas')
            canvas.width = 800
            canvas.height = 600
            const ctx = canvas.getContext('2d')
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#f0f0f0'
            ctx.fillRect(0, 0, 800, 600)
            
            // ç»˜åˆ¶æ•°å­¦é¢˜
            ctx.fillStyle = '#000'
            ctx.font = 'bold 36px Arial'
            ctx.fillText('æ•°å­¦ç»ƒä¹ é¢˜', 50, 80)
            
            ctx.font = '28px Arial'
            ctx.fillText('1. 25 + 37 = ?', 50, 150)
            ctx.fillText('2. 84 - 29 = ?', 50, 200)
            ctx.fillText('3. 6 Ã— 8 = ?', 50, 250)
            ctx.fillText('4. 72 Ã· 9 = ?', 50, 300)
            
            // æ·»åŠ ä¸€äº›è£…é¥°çº¿æ¡
            ctx.strokeStyle = '#ccc'
            ctx.lineWidth = 2
            for (let i = 0; i < 10; i++) {
                ctx.beginPath()
                ctx.moveTo(0, i * 60)
                ctx.lineTo(800, i * 60)
                ctx.stroke()
            }
            
            return canvas.toDataURL('image/jpeg', 0.9).split(',')[1]
        }
        
        // æµ‹è¯•å‡½æ•°
        async function testOCR(imageData, resultElementId, testName) {
            const resultElement = document.getElementById(resultElementId)
            
            resultElement.className = 'result loading'
            resultElement.innerHTML = `
                <h4>ğŸ”„ ${testName}</h4>
                <p><span class="loader"></span> æ­£åœ¨æ‰§è¡Œè¶…æ¿€è¿›å‹ç¼©å’ŒOCRè¯†åˆ«...</p>
                <p>â±ï¸ é¢„è®¡æ—¶é—´: 15-30ç§’</p>
            `
            
            const startTime = Date.now()
            
            try {
                const response = await fetch('http://localhost:3000/api/ocr/recognize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        imageData: imageData,
                        format: 'jpg',
                        accurate: true
                    })
                })
                
                const endTime = Date.now()
                const duration = ((endTime - startTime) / 1000).toFixed(1)
                
                if (!response.ok) {
                    const errorData = await response.json()
                    throw new Error(`${response.status}: ${errorData.message || response.statusText}`)
                }
                
                const result = await response.json()
                
                resultElement.className = 'result success'
                resultElement.innerHTML = `
                    <h4>âœ… ${testName} - æˆåŠŸï¼</h4>
                    <p><strong>è€—æ—¶:</strong> ${duration}ç§’</p>
                    <p><strong>è¯†åˆ«ç»“æœ:</strong></p>
                    <ul>
                        ${result.data.ocrText.map(text => `<li>${text}</li>`).join('')}
                    </ul>
                    <p><strong>ç½®ä¿¡åº¦:</strong> ${result.data.confidence}</p>
                    <p><strong>å­¦ç§‘:</strong> ${result.data.subject}</p>
                    <p><strong>å¹´çº§:</strong> ${result.data.grade}</p>
                    <p><strong>é¢˜ç›®æ•°é‡:</strong> ${result.data.questionCount}</p>
                    <div style="background: #E8F5E8; padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <strong>ğŸ¯ å‹ç¼©ä¿¡æ¯:</strong><br>
                        å›¾ç‰‡å¤§å°: ${result.data.imageInfo.size}<br>
                        APIä½¿ç”¨: ${result.data.apiUsage.totalTokens} tokens
                    </div>
                `
                
            } catch (error) {
                const endTime = Date.now()
                const duration = ((endTime - startTime) / 1000).toFixed(1)
                
                resultElement.className = 'result error'
                resultElement.innerHTML = `
                    <h4>âŒ ${testName} - å¤±è´¥</h4>
                    <p><strong>è€—æ—¶:</strong> ${duration}ç§’</p>
                    <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${error.message}</p>
                    <div style="background: #F8D7DA; padding: 10px; border-radius: 8px; margin-top: 10px;">
                        <strong>ğŸ“‹ æ•…éšœæ’é™¤å»ºè®®:</strong><br>
                        1. æ£€æŸ¥å›¾ç‰‡æ˜¯å¦è¿‡å¤§æˆ–è¿‡äºå¤æ‚<br>
                        2. ç¡®è®¤æœåŠ¡å™¨è¿è¡Œæ­£å¸¸<br>
                        3. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>
                        4. å¦‚æœä»ç„¶å¤±è´¥ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–å‹ç¼©ç­–ç•¥
                    </div>
                `
            }
        }
        
        // é¢„è®¾æµ‹è¯•å‡½æ•°
        async function testSimpleMath() {
            const imageData = createTestImage()
            await testOCR(imageData, 'presetResult', 'ç®€å•æ•°å­¦é¢˜æµ‹è¯•')
        }
        
        async function testComplexMath() {
            // åˆ›å»ºæ›´å¤æ‚çš„æµ‹è¯•å›¾ç‰‡
            const canvas = document.createElement('canvas')
            canvas.width = 1200
            canvas.height = 800
            const ctx = canvas.getContext('2d')
            
            ctx.fillStyle = '#ffffff'
            ctx.fillRect(0, 0, 1200, 800)
            
            ctx.fillStyle = '#000000'
            ctx.font = 'bold 32px Arial'
            ctx.fillText('å°å­¦æ•°å­¦ç»¼åˆç»ƒä¹ ', 50, 60)
            
            ctx.font = '24px Arial'
            const questions = [
                '1. è®¡ç®—ï¼š125 + 389 - 267 = ?',
                '2. å¡«ç©ºï¼š6 Ã— ? = 144',
                '3. åº”ç”¨é¢˜ï¼šå°æ˜æœ‰45ä¸ªè‹¹æœï¼Œç»™äº†å°çº¢12ä¸ªï¼Œåˆä¹°äº†28ä¸ªï¼Œç°åœ¨æœ‰å¤šå°‘ä¸ªï¼Ÿ',
                '4. åˆ†æ•°è®¡ç®—ï¼š3/4 + 1/8 = ?',
                '5. å‡ ä½•ï¼šé•¿æ–¹å½¢é•¿8cmï¼Œå®½5cmï¼Œé¢ç§¯æ˜¯å¤šå°‘ï¼Ÿ'
            ]
            
            questions.forEach((q, i) => {
                ctx.fillText(q, 50, 120 + i * 80)
            })
            
            const imageData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1]
            await testOCR(imageData, 'presetResult', 'å¤æ‚æ•°å­¦é¢˜æµ‹è¯•')
        }
        
        async function testLargeImage() {
            // åˆ›å»ºä¸€ä¸ªå¤§å›¾ç‰‡æ¥æµ‹è¯•å‹ç¼©æ•ˆæœ
            const canvas = document.createElement('canvas')
            canvas.width = 2000  // å¾ˆå¤§çš„å°ºå¯¸
            canvas.height = 1500
            const ctx = canvas.getContext('2d')
            
            // åˆ›å»ºå¤æ‚çš„èƒŒæ™¯å›¾æ¡ˆ
            for (let x = 0; x < 2000; x += 50) {
                for (let y = 0; y < 1500; y += 50) {
                    ctx.fillStyle = `hsl(${(x + y) % 360}, 50%, 80%)`
                    ctx.fillRect(x, y, 45, 45)
                }
            }
            
            // æ·»åŠ æ•°å­¦é¢˜
            ctx.fillStyle = '#000'
            ctx.font = 'bold 48px Arial'
            ctx.fillText('è¿™æ˜¯ä¸€ä¸ªå¤§å›¾ç‰‡å‹ç¼©æµ‹è¯•', 100, 100)
            
            ctx.font = '36px Arial'
            ctx.fillText('åŸå§‹å°ºå¯¸: 2000x1500 åƒç´ ', 100, 180)
            ctx.fillText('é¢„è®¡æ–‡ä»¶å¤§å°: >500KB', 100, 240)
            ctx.fillText('ç›®æ ‡å‹ç¼©å: <30KB, <320px', 100, 300)
            
            const imageData = canvas.toDataURL('image/jpeg', 0.9).split(',')[1]
            await testOCR(imageData, 'presetResult', 'å¤§å›¾ç‰‡å‹ç¼©æµ‹è¯•')
        }
        
        // è‡ªå®šä¹‰å›¾ç‰‡æµ‹è¯•
        async function testCustomImage(input) {
            const file = input.files[0]
            if (!file) return
            
            const reader = new FileReader()
            reader.onload = async function(e) {
                const base64Data = e.target.result.split(',')[1]
                await testOCR(base64Data, 'uploadResult', `è‡ªå®šä¹‰å›¾ç‰‡æµ‹è¯• (${file.name})`)
            }
            reader.readAsDataURL(file)
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        window.onload = function() {
            checkServerStatus()
        }
    </script>
</body>
</html> 