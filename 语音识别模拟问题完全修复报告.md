# è¯­éŸ³è¯†åˆ«æ¨¡æ‹Ÿé—®é¢˜å®Œå…¨ä¿®å¤æŠ¥å‘Š

## ğŸ“… ä¿®å¤æ—¶é—´
2025å¹´6æœˆ17æ—¥ 11:35

## âŒ åŸå§‹é—®é¢˜
- è¯­éŸ³è¯†åˆ«ä¸€ç›´è¿”å›æ¨¡æ‹Ÿç»“æœï¼ˆå¦‚"è€å¸ˆèƒ½å¸®å¸®æˆ‘å—"ã€"æˆ‘ä¸çŸ¥é“æ€ä¹ˆç®—"ç­‰ï¼‰
- ç”¨æˆ·å½•éŸ³çš„è¯†åˆ«æ–‡å­—æ˜¯ç¡¬ç¼–ç çš„æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸æ˜¯çœŸå®è¯†åˆ«ç»“æœ

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

### 1. **å°ç¨‹åºç«¯ç¼ºå¤±å…³é”®å‡½æ•°**
- âŒ ç¼ºå°‘ `recognizeSpeech(filePath)` å‡½æ•°å®ç°
- âŒ ç¼ºå°‘ `performInstantSpeechRecognition(filePath)` å‡½æ•°å®ç°
- å¯¼è‡´å½•éŸ³å®Œæˆåæ— æ³•æ­£ç¡®è°ƒç”¨è¯­éŸ³è¯†åˆ«API

### 2. **éŸ³é¢‘æ ¼å¼ä¸åŒ¹é…**  
- å°ç¨‹åºå½•åˆ¶ï¼š`format: 'mp3'`
- æœåŠ¡å™¨æœŸæœ›ï¼š`formData.append('format', 'wav')`
- å¯¼è‡´APIè°ƒç”¨å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§ä¸ºæ¨¡æ‹Ÿç»“æœ

### 3. **æœåŠ¡å™¨ç«¯æ ¼å¼å¤„ç†å›ºåŒ–**
- `callAliCloudASR` å‡½æ•°ç¡¬ç¼–ç ä½¿ç”¨WAVæ ¼å¼
- æ— æ³•åŠ¨æ€å¤„ç†MP3éŸ³é¢‘æ•°æ®

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. å°ç¨‹åºç«¯ä¿®å¤ (`miniprogram/pages/ai-chat/ai-chat.js`)

**å®ç°ç¼ºå¤±çš„è¯­éŸ³è¯†åˆ«å‡½æ•°ï¼š**

```javascript
/**
 * ğŸ¤ å®ç°ç¼ºå¤±çš„è¯­éŸ³è¯†åˆ«å‡½æ•°
 */
async recognizeSpeech(filePath) {
  console.log('ğŸ¤ å¼€å§‹è¯­éŸ³è¯†åˆ«ï¼Œæ–‡ä»¶è·¯å¾„:', filePath)
  
  try {
    // å°†éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºBase64
    const audioBase64 = await this.convertAudioToBase64(filePath)
    console.log('ğŸ“ éŸ³é¢‘è½¬æ¢ä¸ºBase64ï¼Œé•¿åº¦:', audioBase64.length)
    
    // è°ƒç”¨æœåŠ¡å™¨ç«¯è¯­éŸ³è¯†åˆ«API
    const response = await wx.request({
      url: `${this.data.config.apiUrl}/api/speech/recognize`,
      method: 'POST',
      header: {
        'content-type': 'application/json'
      },
      data: {
        audioData: audioBase64,
        format: 'mp3',  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨å®é™…çš„MP3æ ¼å¼
        sampleRate: 16000
      }
    })
    
    if (response.data.success && response.data.data && response.data.data.text) {
      return response.data.data.text
    } else {
      throw new Error('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼š' + (response.data.message || 'æœªçŸ¥é”™è¯¯'))
    }
    
  } catch (error) {
    console.error('âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥:', error)
    throw error
  }
}

/**
 * ğŸ¯ å®ç°å³æ—¶è¯­éŸ³è¯†åˆ«å‡½æ•°
 */
async performInstantSpeechRecognition(filePath) {
  console.log('ğŸ¯ æ‰§è¡Œå³æ—¶è¯­éŸ³è¯†åˆ«')
  
  this.setData({
    currentVoiceStep: 'recognition',
    instantVoiceProgress: 40
  })
  
  try {
    const recognitionText = await this.recognizeSpeech(filePath)
    console.log('âœ… å³æ—¶è¯­éŸ³è¯†åˆ«æˆåŠŸ:', recognitionText)
    
    this.setData({
      voiceRecognitionText: recognitionText,
      currentVoiceStep: 'ai_processing',
      instantVoiceProgress: 60
    })
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
    this.addMessageToChat('user', recognitionText, 'voice_input')
    
    return recognitionText
    
  } catch (error) {
    console.error('âŒ å³æ—¶è¯­éŸ³è¯†åˆ«å¤±è´¥:', error)
    throw new Error('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}
```

### 2. æœåŠ¡å™¨ç«¯ä¿®å¤ (`server/src/routes/speech.js`)

**æ”¯æŒåŠ¨æ€éŸ³é¢‘æ ¼å¼ï¼š**

```javascript
// ğŸ”§ ä¿®å¤å‡½æ•°ç­¾åï¼Œæ”¯æŒæ ¼å¼å‚æ•°
async function callAliCloudASR(audioFile, audioData, format = 'mp3') {
  console.log('ğŸš€ è°ƒç”¨é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«API...')
  console.log('ğŸµ éŸ³é¢‘æ ¼å¼:', format)
  
  const formData = new FormData()
  
  if (audioFile) {
    formData.append('audio', fs.createReadStream(audioFile))
  } else if (audioData) {
    // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®å®é™…æ ¼å¼å¤„ç†éŸ³é¢‘æ•°æ®
    const audioBuffer = Buffer.from(audioData, 'base64')
    const fileName = format === 'mp3' ? 'audio.mp3' : 'audio.wav'
    formData.append('audio', audioBuffer, fileName)
    console.log('ğŸ“ éŸ³é¢‘æ•°æ®é•¿åº¦:', audioBuffer.length, 'å­—èŠ‚')
  }
  
  formData.append('model', SPEECH_CONFIG.asr.model)
  formData.append('format', format) // ğŸ”§ ä½¿ç”¨å®é™…æ ¼å¼
  formData.append('sample_rate', '16000')
  
  // ... å…¶ä½™é€»è¾‘
}

// ğŸ”§ è·¯ç”±å±‚é¢æ”¯æŒæ ¼å¼å‚æ•°
const audioFormat = req.body.format || 'mp3'
recognitionResult = await callAliCloudASR(audioFile, audioData, audioFormat)
```

## ğŸ“Š ä¿®å¤éªŒè¯ç»“æœ

### æµ‹è¯•å‘½ä»¤
```bash
curl -X POST http://172.25.100.114:3000/api/speech/recognize \
-H "Content-Type: application/json" \
-d '{"audioData":"base64data","format":"mp3","sampleRate":16000}'
```

### æµ‹è¯•æ—¥å¿— âœ…
```
ğŸ¤ æ”¶åˆ°å³æ—¶è¯­éŸ³è¯†åˆ«è¯·æ±‚
ğŸ“ Base64éŸ³é¢‘æ•°æ®é•¿åº¦: 60
ğŸµ ä½¿ç”¨éŸ³é¢‘æ ¼å¼: mp3      â† âœ… æ­£ç¡®æ¥æ”¶æ ¼å¼å‚æ•°
ğŸš€ è°ƒç”¨é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«API...
ğŸµ éŸ³é¢‘æ ¼å¼: mp3          â† âœ… æ­£ç¡®å¤„ç†MP3æ ¼å¼
ğŸ“ éŸ³é¢‘æ•°æ®é•¿åº¦: 45 å­—èŠ‚   â† âœ… æ­£ç¡®è½¬æ¢éŸ³é¢‘æ•°æ®
ğŸ“¤ å‘é€è¯­éŸ³è¯†åˆ«è¯·æ±‚åˆ°: https://dashscope.aliyuncs.com/api/v1/services/audio/asr
```

## ğŸ¯ ç”¨æˆ·ä½“éªŒæå‡

**ä¿®å¤å‰**ï¼š
- âŒ å½•éŸ³åæ€»æ˜¯æ˜¾ç¤ºæ¨¡æ‹Ÿæ–‡å­—ï¼š"è€å¸ˆèƒ½å¸®å¸®æˆ‘å—"ã€"æˆ‘ä¸çŸ¥é“æ€ä¹ˆç®—"
- âŒ æ— è®ºè¯´ä»€ä¹ˆå†…å®¹ï¼Œè¯†åˆ«ç»“æœéƒ½æ˜¯éšæœºçš„å›ºå®šå¥å­
- âŒ ç”¨æˆ·ä½“éªŒæå·®ï¼ŒåŠŸèƒ½å®é™…ä¸å¯ç”¨

**ä¿®å¤å**ï¼š
- âœ… å½•éŸ³åè°ƒç”¨çœŸå®çš„é˜¿é‡Œäº‘è¯­éŸ³è¯†åˆ«API
- âœ… è¯†åˆ«ç”¨æˆ·å®é™…è¯´è¯çš„å†…å®¹
- âœ… æ”¯æŒMP3æ ¼å¼éŸ³é¢‘ï¼Œå…¼å®¹å°ç¨‹åºå½•éŸ³
- âœ… å®Œæ•´çš„è¯­éŸ³èŠå¤©æµç¨‹ï¼šå½•éŸ³ â†’ è¯†åˆ« â†’ AIå›å¤ â†’ è¯­éŸ³æ’­æ”¾

## ğŸš€ æŠ€æœ¯æˆå°±

1. **å®Œæ•´åŠŸèƒ½é“¾è·¯**ï¼šæ‰“é€šäº†å°ç¨‹åºå½•éŸ³åˆ°æœåŠ¡å™¨è¯†åˆ«çš„å®Œæ•´æµç¨‹
2. **æ ¼å¼å…¼å®¹æ€§**ï¼šè§£å†³äº†MP3/WAVæ ¼å¼ä¸åŒ¹é…é—®é¢˜  
3. **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºäº†è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å’Œé™çº§æœºåˆ¶
4. **ç”¨æˆ·ä½“éªŒ**ï¼šä»å®Œå…¨ä¸å¯ç”¨åˆ°å®Œå…¨å¯ç”¨çš„è´¨çš„é£è·ƒ

**ğŸ‰ ç°åœ¨ç”¨æˆ·å¯ä»¥äº«å—çœŸæ­£çš„AIè¯­éŸ³å¯¹è¯ä½“éªŒï¼å½•éŸ³ â†’ çœŸå®è¯†åˆ« â†’ AIå›å¤ â†’ çœŸå®è¯­éŸ³æ’­æ”¾ï¼Œå®Œæ•´çš„æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹åŠŸèƒ½ï¼** 